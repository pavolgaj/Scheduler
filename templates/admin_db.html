<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Admin objects DB
        </title>
        <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">

        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 50px;
            }

            table {
                font-family: arial, sans-serif;
                border-collapse: separate;
                /* Don't collapse */
                border-spacing: 0;
                width: 100%;
            }

            td,
            th {
                border: 1px solid black;
                text-align: left;
                padding: 8px;
                white-space: nowrap;
            }

            tr:nth-child(even) {
                background-color: #dddddd;
            }

            tr:nth-child(odd) {
                background-color: white;
            }

            thead th {
                /* fix header */
                position: sticky;
                top: 0;
                /* Stick the header to the top */
                z-index: 1;
                /* Ensure the header stays on top */
                background-color: white;
            }

            .fix {
                /* fix 1st col */
                position: sticky;
                left: 0;
                z-index: 0;
                background-color: inherit;
            }

            button {
                padding: 10px 20px;
                border: none;
                border-radius: 5px;
                background-color: #333;
                color: white;
                cursor: pointer;
            }

            button:hover {
                background-color: #555;
            }

            button:disabled,
            button[disabled] {
                border: 1px solid #999999;
                background-color: #cccccc;
                color: #666666;
            }

            .actions {
                width: 70px;
                display: table-cel;
                font-size: 0em;
                justify-content: left;
            }

            .modify-row {
                padding: 0px;
                width: 20px;
                height: 20px;
                background-color: silver;
                border-color: black;
                border-width: 1px;
                border-radius: 5px;
                margin-right: 2px;
            }

            .modify-row img {
                height: 17px;
                display: block;
                margin-left: auto;
                margin-right: auto;
            }

            input[type="text"] {
                width: 100%;
                box-sizing: border-box;
                border: none;
                background-color: transparent;
                /* Make background transparent */
                font-family: inherit;
                /* Inherit font styles from the table */
                font-size: inherit;
                padding: 0;
                margin: 0;
                min-width: 150px;
            }

            input:focus {
                border: none;
                outline: none;
            }

            label {
                font-weight: bold;
            }

            select {
                padding: 10px;
                border-radius: 5px;
                border: 1px solid #ccc;
                width: 150px;
            }

            #searchInput {
                padding: 10px;
                border-radius: 5px;
                width: 20%;
                min-width: 100px;
                max-width: 200px;
                margin-bottom: 10px;
                margin-top: 10px;
                border: 1px solid #ccc;
            }
        </style>
        <!-- import basic jquery functions -> used for sorting -->
        <script src="{{ url_for('static', filename='jquery.min.js') }}"></script>
        <script>
            //reload page (submit form) on change of db type
            function updateDB() {
                document.getElementById('db-form').submit();
            }
            // DISABLE submit form on ENTER
            document.addEventListener('DOMContentLoaded', (event) => {
                const form = document.querySelector('form');
                form.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                    }
                });
            });

            function searchTab() {
                // filter in tables
                var input, filter, table, tr, td, cell, i, j;
                input = document.getElementById("searchInput");
                filter = input.value.toUpperCase();
                table = document.getElementById("my_table");
                tr = table.getElementsByTagName("tr");
                {% if db == 'new' %}
                ids = document.getElementById("selected");
                ids.value = '';
                {% endif %}

                var n = 0;
                for (i = 1; i < tr.length; i++) {
                    // Hide the row initially.
                    tr[i].style.display = "none";

                    if (n > 100) {
                        //show no more than 100 rows
                        continue;
                    }

                    td = tr[i].getElementsByTagName("td");
                    for (var j = 0; j < td.length; j++) {
                        cell = tr[i].getElementsByTagName("td")[j];
                        if (cell) {
                            if (cell.innerHTML.toUpperCase().indexOf(filter) > -1) {
                                tr[i].style.display = "";
                                indexInput = tr[i].querySelector('input#id');
                                {% if db == 'new' %}
                                ids.value = ids.value + indexInput.value + ',';
                                {% endif %}
                                n += 1;
                                break;
                            }
                        }
                    }
                }

                {% if db == 'objects' %}
                if (!filter) { updateRows(); }
                {% endif %}
            }


            function updateRows() {
                // filter of rows in table
                {% if db == 'new' %}
                ids = document.getElementById("selected");
                ids.value = '';
                {% endif %}

                const table = document.getElementById('my_table');

                if (!table) return;

                const tbody = table.querySelector("tbody");
                if (!tbody) return;

                const rows = tbody.getElementsByTagName("tr");

                const filter = document.getElementById('rows');
                var start = parseInt(filter.value);
                var end = start + 100;

                for (let i = 0; i < rows.length; i++) {
                    if (i + 1 >= start && i + 1 <= end) {
                        rows[i].style.display = ""; // show
                        indexInput = rows[i].querySelector('input#id');
                        {% if db == 'new' %}
                        ids.value = ids.value + indexInput.value + ',';
                        {% endif %}
                    } else {
                        rows[i].style.display = "none"; // hide
                    }
                }

            }

            function deleteRow(target) {
                num = saveRowNum();
                if (num) {
                    return confirm("Delete target '" + target + "'?");
                }
                return false;
            }

            function saveRowNum() {
                // test number of displayed rows -> save only if no more than 100 rows (possible problem...)
                const num = $('#my_table tr:visible').length;
                if (num > 101) {
                    alert("Not show more than 100 rows when saving DB!!!")
                    return false;
                }
                return true;
            }

            function details() {
                var w = window.open();
                var html = '<html><body><ul>';
                {% for key in tooltips %}
                html=html+'<li><b>{{ key }}</b> - {{ tooltips[key] }}</li>'
                {% endfor %}
                html=html+'</ul></body></html>'
                w.document.write(html);
            }

            function question(text) {
                let mess=prompt(text+'\n\nMessage to supervisor:',"");
                if (mess == null) { return false; }
                document.getElementById('mess').value=mess;
                return true;
            }
        </script>
    </head>

    <body>
        <form method="post" id="db-form">
            <label for="db">Object DB to edit:</label>
            <select id="db" name="db" onchange="updateDB()">
                <option value="new" {% if db=='new' %}selected{% endif %}>New objects</option>
                <option value="objects" {% if db=='objects' %}selected{% endif %}>Objects in DB</option>
            </select>

            <input type="hidden" id="mess" name="mess" value="">

            {% if errors %}
            <script>
                alert("Fix problems with data format!")
            </script>
            {% endif %}

            <!-- shows errors in data -->
            {% if errors %}
            <ul style="color:red;">
                {% for error in errors %}
                <li>{{ error }}</li>
                {% endfor %}
            </ul>
            {% endif %}

            <br>
            <input type="text" id="searchInput" name="searchInput" onkeyup="searchTab()" value="{{ searchInput }}"
                placeholder="Search for target..." title="Search for target in DB.">

            <!-- Table for new objects -->
            {% if db=='new' %}
            <center>
                <h1>New Objects</h1>
                <button type="submit" name="download" title="Download" {%if not data %}disabled{% endif %}>Download CSV
                </button>
                <button type="submit" name="accept_all" title="Accept all targets and move them to DB."
                    onclick="return question('Accept all targets and move them to DB?');" {%if not data %}disabled{% endif %}>Accept all
                </button>
                <button type="submit" name="delete_all" title="Delete all targets"
                    onclick="return question('Delete all targets?');" {%if not data %}disabled{% endif %}>Delete all
                </button>
                <button type="submit" name="accept_select" title="Accept selected targets and move them to DB."
                    onclick="return question('Accept selected targets and move them to DB?');" {%if not data %}disabled{% endif %}>Accept selected
                </button>
                <button type="submit" name="delete_select" title="Delete selected targets"
                    onclick="return question('Delete selected targets?');" {%if not data %}disabled{% endif %}>Delete selected
                </button>
            </center>
            <h2 style="color: red; font-weight: bold;">Any accept/delete action also saves all modifications in table!
            </h2>
            <br>
            <label for="rows">Rows to show:</label>
            <select id="rows" name="rows" onchange="updateRows()">
                {% for i in range(0,data|length,100) %}
                <option value="{{ i }}" {% if rows==i %}selected{% endif %}>{{ i }} - {{ i+100 }}</option>
                {% endfor %}
            </select>
            &nbsp;&nbsp;&nbsp;
            <button type="button" name="info" title="Show requirement on data format."
                onclick="details()">Format info</button>
            <br>
            <br>
            <input type="hidden" name="selected" id="selected">
            <table id="my_table">
                <thead>
                    <tr>
                        <!-- fix first 2 cols -->
                        <th style="position: sticky; left: 0px; z-index: 2; background-color: white; min-width: 100px;">
                        </th>
                        <th style="display:none">id</th> <!-- id for correct sorting -->
                        {% for val in header %}
                        <th {% if loop.index0==0
                            %}style="position: sticky; left: 100px; z-index: 2; background-color: white;" {% endif %}>
                            {{ val }}
                        </th>
                        {% endfor %}
                    </tr>
                </thead>
                {% for row in data %}
                <tr data-row-id="{{ loop.index0 }}">
                    <!-- fix first 2 cols -->
                    <td class="actions" style="position: sticky; left: 0px; z-index: 0; background-color: inherit;">
                        <button type="submit" class="modify-row" name="accept_{{ loop.index0 }}"
                            title="Accept target and move it to DB."
                            onclick="return question('Accept target \'{{ row['Target'] }}\'?');">
                            <img src="{{ url_for('static',filename='accept.svg') }}" alt="accept">
                        </button>
                        <button type="submit" class="modify-row" name="delete_{{ loop.index0 }}" title="Delete target"
                            onclick="return question('Delete target \'{{ row['Target'] }}\'?');">
                            <img src="{{ url_for('static',filename='delete.svg') }}" alt="delete">
                        </button>
                        <button type="button" class="modify-row" name="info" title="Info about observing program"
                            onclick="window.open('{{ url_for('proposal_info', name = row['ProgramID']) }}', '_blank')"
                            formtarget=”_blank”>
                            <img src="{{ url_for('static',filename='info.svg') }}" alt="preview">
                        </button>
                        <button type="button" class="modify-row" name="info" title="Search in Simbad"
                            onclick="window.open('https://simbad.u-strasbg.fr/simbad/sim-basic?Ident={{ row.RA }}{% if not row.DEC[0]=='-' %}%2B{% endif %}{{ row.DEC | replace('+','') }}', '_blank')"
                            formtarget=”_blank”>
                            <img src="{{ url_for('static',filename='simbad.svg') }}" alt="simbad">
                        </button>
                    </td>
                    <td style="display:none">
                        <input type="hidden" name="id" id="id" value="{{ loop.index0 }}">
                        <!-- id for correct sorting -->
                    </td>
                    <script>
                        ids = document.getElementById("selected");
                        ids.value = ids.value + '{{ loop.index0 }},';
                    </script>
                    {% for col in header %}
                    <td {% if loop.index0==0 %}class="fix" style="left: 100px;" {% endif %}>
                        <input type="text" name="{{ col }}" value="{{ row[col] }}" {% if col in tooltips
                            %}title="{{ tooltips[col] }}" {% endif %}>
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </table>
            {% endif %}


            <!-- Table for objects in final DB -->
            {% if db=='objects' %}
            {% if saved %}
            <script>
                alert("Object DB saved!")
            </script>
            {% endif %}
            <center>
                <h1>Objects in database</h1>
                <button type="submit" name="download" title="Download" {%if not data %}disabled{% endif %}>Download CSV
                </button>
                <button type="submit" name="save" title="Save DB" onclick="return saveRowNum();">Save DB
                </button>
            </center>
            <h2 style="color: red; font-weight: bold;">Not show more than 100 rows when saving DB!!!</h2>
            <h2 style="color: red; font-weight: bold;">Any delete action also saves all modifications in table!</h2>
            <br>
            <label for="rows">Rows to show:</label>
            <select id="rows" name="rows" onchange="updateRows()">
                {% for i in range(0,data|length,100) %}
                <option value="{{ i }}" {% if rows==i %}selected{% endif %}>{{ i }} - {{ i+100 }}</option>
                {% endfor %}
            </select>
            &nbsp;&nbsp;&nbsp;
            <button type="button" name="info" title="Show requirement on data format."
                onclick="details()">Format info</button>
            &nbsp;&nbsp;&nbsp;
            <button type="button" name="changes" title="Show list of requested changes."
                onclick="window.open('{{ url_for('changes') }}', '_blank')">Requested changes</button>
            <br>
            <br>
            <table id="my_table">
                <thead>
                    <tr>
                        <!-- fix first 3 cols -->
                        <th style="position: sticky; left: 0px; z-index: 2; background-color: white; min-width: 80px;">
                        </th>
                        <th style="position: sticky; left: 80px; z-index: 2; background-color: white;">Done</th>
                        <th style="display:none">id</th> <!-- id for correct sorting -->
                        {% for val in header %}
                        <th {% if loop.index0==0 %}
                            style="position: sticky; left: 135px; z-index: 2; background-color: white;" {% endif %}>
                            {{ val }}
                        </th>
                        {% endfor %}
                    </tr>
                </thead>
                {% for row in data %}
                <tr data-row-id="{{ loop.index0 }}">
                    <!-- fix first 3 cols -->
                    <td class="actions" style="position: sticky; left: 0px; z-index: 0; background-color: inherit;">
                        <button type="submit" class="modify-row" name="delete_{{ loop.index0 }}" title="Delete target"
                            onclick="return deleteRow('{{ row['Target'] }}')">
                            <img src="{{ url_for('static',filename='delete.svg') }}" alt="delete">
                        </button>
                        <button type="button" class="modify-row" name="info" title="Info about observing program"
                            onclick="window.open('{{ url_for('proposal_info', name = row['ProgramID']) }}', '_blank')"
                            formtarget=”_blank”>
                            <img src="{{ url_for('static',filename='info.svg') }}" alt="preview">
                        </button>
                        <button type="button" class="modify-row" name="info" title="Search in Simbad"
                            onclick="window.open('https://simbad.u-strasbg.fr/simbad/sim-basic?Ident={{ row.RA }}{% if not row.DEC[0]=='-' %}%2B{% endif %}{{ row.DEC | replace('+','') }}', '_blank')"
                            formtarget=”_blank”>
                            <img src="{{ url_for('static',filename='simbad.svg') }}" alt="simbad">
                        </button>
                    </td>
                    <td class="fix" style="left: 80px;">
                        <center>
                            <input type="checkbox" name="Done" value="{{ loop.index0 }}" title="Observations finished?"
                                {% if row['Done']=='1' %}checked{% endif %}> <!-- if checked -> value from id -->
                        </center>
                    </td>
                    <td style="display:none">
                        <input type="text" name="id" value="{{ loop.index0 }}"> <!-- id for correct sorting -->
                    </td>
                    {% for col in header %}
                    <td {% if loop.index0==0 %} class="fix" style="left: 135px;" {% endif %}>
                        <input type="text" name="{{ col }}" value="{{ row[col] }}" {% if col in tooltips
                            %}title="{{ tooltips[col] }}" {% endif %}>
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </table>
            {% endif %}

        </form>
        <br>


        <script>
            // apply search filter after POST
            window.onload = function () {
                {% if searchInput %}
                searchTab();
                {% elif data %}
                updateRows();
                {% endif %}
            }
        </script>

    </body>
    <script>
        // sorting table

        function sortTable(f, n) {
            // get all rows from table
            let rows = $('#my_table tbody  tr').get();

            rows.sort(function (a, b) {
                // algorithm for sorting

                let A = getVal(a);
                let B = getVal(b);

                if (A < B) {
                    return -1 * f;
                }
                if (A > B) {
                    return 1 * f;
                }
                return 0;
            });

            function getVal(elm) {
                let v = $(elm).children('td').eq(n).find("input").val().toUpperCase();   // sort using value in input
                {% if db == 'objects' %}
                if (n === 1) {
                    // checkboxes for done
                    return $(elm).children('td').eq(n).find("input")[0].checked;
                }
                if (n === 3) {
                    {% else %}
                    if (n === 2) {
                        {% endif %}
                        return v.replace(" ", "").replace("-", "").replace("_", "");   //col with target name
                    }
                    if (n > 9 && v.length == 10 && !isNaN(Date.parse(v))) {
                        v = Date.parse(v);  //date
                    }
                    else if ($.isNumeric(v)) {
                        v = parseFloat(v, 10);
                    }
                    else if ($.isNumeric(v.slice(0, 3))) {
                        v = parseFloat(v.slice(0, 3), 10);    // RA/DEC -> number from 1st part
                    }
                    else if ($.isNumeric(v.slice(0, 2))) {
                        v = parseFloat(v.slice(0, 2), 10);     // RA/DEC -> number from 1st part
                    }
                    else if ($.isNumeric(v.slice(0, 1))) {
                        v = parseFloat(v.slice(0, 1), 10);     // RA/DEC -> number from 1st part
                    }
                    else if (v === 'SERIES') {
                        v = 50;                                 // number of exp.=series -> set some big number
                    }
                    return v;
                }

                $.each(rows, function (index, row) {
                    $('#my_table').children('tbody').append(row);
                });
            }
            let f_sl = 1;

            $(function () {

                $("#my_table th").click(function () {
                    {% if db == 'objects' and data %}
                    if (!document.getElementById("searchInput").value) {
                        const table = document.getElementById('my_table');
                        const rows = table.getElementsByTagName("tr");
                        for (let i = 0; i < rows.length; i++) {
                            rows[i].style.display = ""; // show
                        }
                    }
                    {% endif %}

                    var headers = document.getElementsByTagName("th");    // get header
                    var old = -1;
                    for (var i = 0; i < headers.length; i++) {
                        // remove symbol from old sorting col and save its index
                        if (headers[i].innerHTML.indexOf('▼') > 0) {
                            old = i;
                            headers[i].innerHTML = headers[i].innerHTML.slice(0, headers[i].innerHTML.indexOf('▼') - 1);
                            break;
                        }
                        if (headers[i].innerHTML.indexOf('▲') > 0) {
                            old = i;
                            headers[i].innerHTML = headers[i].innerHTML.slice(0, headers[i].innerHTML.indexOf('▲') - 1);
                            break;
                        }
                    }

                    let n = $(this).prevAll().length

                    if (old === n) {
                        f_sl *= -1;   // resort old col
                    }
                    else {
                        f_sl = 1;     // sorting using new col
                    }

                    sortTable(f_sl, n)

                    // add symbol to header
                    if (f_sl === -1)
                        $(this).text($(this).text() + " ▼")
                    else
                        $(this).text($(this).text() + " ▲")

                    {% if db == 'objects' and data %}
                    if (!document.getElementById("searchInput").value) {
                        updateRows();
                    }
                    {% endif %}
                });

            });

    </script>

</html>