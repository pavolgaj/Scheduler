<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Modify schedule</title>
        <script src="{{ url_for('static', filename='jquery.min.js') }}"></script>
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 50px;
            }

            table {
                font-family: arial, sans-serif;
                border-collapse: separate;
                /* Don't collapse */
                border-spacing: 0;
                width: 100%;
            }

            td,
            th {
                border: 1px solid black;
                text-align: left;
                padding: 8px;
                white-space: nowrap;
            }

            tr:nth-child(even) {
                background-color: #dddddd;
            }

            label {
                margin-bottom: 8px;
                font-weight: bold;
            }

            select {
                padding: 10px;
                border-radius: 5px;
                width: 20%;
                min-width: 100px;
            }

            input {
                padding: 10px;
                border-radius: 5px;
                width: 20%;
                min-width: 100px;
                max-width: 200px;
            }

            button {
                padding: 10px 20px;
                border: none;
                border-radius: 5px;
                background-color: #333;
                color: white;
                cursor: pointer;
            }

            button:hover {
                background-color: #555;
            }

            .actions {
                width: 45px;
                display: table-cel;
                font-size: 0em;
                justify-content: left;
            }

            .modify-row {
                padding: 0px;
                width: 20px;
                height: 20px;
                background-color: silver;
                border-color: black;
                border-width: 1px;
                border-radius: 5px;
                margin-right: 2px;
            }

            .modify-row img {
                height: 17px;
                display: block;
                margin-left: auto;
                margin-right: auto;
            }

            .scrollable-table {
                overflow-y: auto;
                /* Enable vertical scrolling */
            }

            thead th {
                /* fix header */
                position: sticky;
                top: 0;
                /* Stick the header to the top */
                z-index: 1;
                /* Ensure the header stays on top */
                background-color: white;
            }

            .fix {
                /* fix 1st col */
                position: sticky;
                left: 0;
                z-index: 0;
                background-color: inherit;
                /* same color as row */
            }

            .no_border td {
                border: none;
            }

            .border td {
                border: 1px solid black;
            }

            /* hide border for inputs in table */
            .tab-input {
                width: 100%;
                box-sizing: border-box;
                border: none;
                background-color: transparent;
                /* Make background transparent */
                font-family: inherit;
                /* Inherit font styles from the table */
                font-size: inherit;
                padding: 0;
                margin: 0;
                min-width: 10px;
            }

            img {
                cursor: pointer;
            }
        </style>
        <script>
            // Function to move a row up
            function moveUp(btn) {
                var row = btn.parentNode.parentNode;
                var previousRow = row.previousElementSibling;
                if (previousRow && previousRow.tagName === 'TR') {
                    row.parentNode.insertBefore(row, previousRow);
                }
            }

            // Function to move a row down
            function moveDown(btn) {
                var row = btn.parentNode.parentNode;
                var nextRow = row.nextElementSibling;
                if (nextRow && nextRow.tagName === 'TR') {
                    row.parentNode.insertBefore(nextRow, row);
                }
            }

            // Function to delete a row
            function deleteRow(btn) {
                var row = btn.parentNode.parentNode;
                row.parentNode.removeChild(row);
            }

            // check if obj. group is seledted
            function checkGroup() {
                const checkboxes = document.querySelectorAll('input[type="checkbox"]');
                let isChecked = false;

                checkboxes.forEach((checkbox) => {
                    if (checkbox.checked) {
                        isChecked = true;
                    }
                });
                if (!isChecked) {
                    alert('NO group of object is selected!');
                    return false;
                }
                else {
                    popup();
                }
                return true;
            }

            // check if name is given
            function checkSave() {
                var name = document.getElementById('save-name');
                if (!name.value) {
                    alert('Name of schedule is missing!');
                    return false;
                }
                return true;
            }
            // check if night is given
            function checkTwilight() {
                var night = document.getElementById('night');
                if (!night.value) {
                    alert('Date of scheduling night is missing!');
                    return false;
                }
                return true;
            }
            // check if night and time are given
            function checkStart() {
                var night = document.getElementById('night');
                if (!night.value) {
                    alert('Date of scheduling night is missing!');
                    return false;
                }
                var start = document.getElementById('start');
                if (!start.value) {
                    alert('Observations start is missing!');
                    return false;
                }
                return true;
            }

            function popup() {
                //show info about running, not block server
                var myDialog = document.createElement("dialog");
                document.body.appendChild(myDialog)
                var text = document.createTextNode(" Please, wait...");
                myDialog.appendChild(text);
                myDialog.showModal();
            }

            function isInt(str) {
                // check if string is integer
                return (parseInt(str) == str);
            }

            function checkNum() {
                //check values in inputs (number and exp)                
                let valid = true;

                var inputs = document.getElementsByName('exp');
                inputs.forEach((inp) => {
                    if (!isInt(inp.value)) {
                        valid = false;
                    }
                });
                if (!valid) {
                    alert('Exposure time should be number!');
                    return valid;
                }

                inputs = document.getElementsByName('number');
                inputs.forEach((inp) => {
                    if (!isInt(inp.value)) {
                        valid = false;
                    }
                });
                if (!valid) {
                    alert('Number of exposure should be number!');
                    return valid;
                }
                return valid;
            }

            function rerun() {
                //make some checks before rerun (recalc and reschedule)
                var check = checkStart();
                var valid = checkNum();

                if (check && valid) {
                    popup();
                }
                return (check && valid);
            }

            function select_all() {
                //select all groups
                checkboxes = document.getElementsByName('use_group');
                for (var i = 0; i < checkboxes.length; i++) {
                    checkboxes[i].checked = true;
                }
            }
            function select_none() {
                //select none groups
                checkboxes = document.getElementsByName('use_group');
                for (var i = 0; i < checkboxes.length; i++) {
                    checkboxes[i].checked = false;
                }
            }
            function delete_confirm() {
                //confirm delete schedule
                var name = document.getElementById('name');
                var text = name.value;
                return confirm("Delete selected schedule '" + text + "'?");
            }

            // function updateHiddenInput(cell) {
            //     //update inputs after td change
            //     //var hiddenInput = cell.querySelector('input[type="hidden"]');
            //     var hiddenInput = cell.querySelector('input');
            //     hiddenInput.value = cell.innerText.trim();
            // }

            // DISABLE submit form on ENTER
            document.addEventListener('DOMContentLoaded', (event) => {
                const form = document.querySelector('form');
                form.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                    }
                });
            });

            //Display a base64 URL inside an iframe in another window.
            //for chrome etc. (a href not work!)
            function debugBase64(base64URL) {
                var win = window.open();
                win.document.write('<iframe src="' + base64URL + '" frameborder="0" style="border:0; top:0px; left:0px; bottom:0px; right:0px; width:100%; height:100%;" allowfullscreen></iframe>');
            }

            //This will open an image in a new window
            function img64(data) {
                debugBase64("data:image/png;base64," + data);
            }   
        </script>

    </head>

    <body>
        <form method="post" id="main-form">
            <div>
                <center>
                    <label for="name">Name of scheduler</label>
                    <select name="name" id="name" title="Names of available schedules to modify.">
                        {% for sch in schedules %}
                        <option value="{{ sch }}" {% if name==sch %}selected{% endif %}>{{ sch }}</option>
                        {% endfor %}
                    </select>
                    <button type="submit" name="load" id="load" onclick="popup()" title="Load schedule." {% if not
                        schedules %}disabled style="background-color:gray; color: black; cursor: default;" {% endif
                        %}>Load
                        schedule</button>
                    <button type="submit" name="new" id="new" title="Create empty schedule.">New schedule</button>
                    <button type="submit" name="delete" id="delete" title="Delete selected schedule."
                        onclick="return delete_confirm()" {% if not schedules %}disabled
                        style="background-color:gray; color: black; cursor: default;" {% endif %}>Delete
                        schedule</button>
                    <input type="hidden" name="code" id="code" value="{{ code }}">
                    <!-- store cache uuid for reload df -->
                    <input type="hidden" name="codeF" id="codeF" value="{{ codeF }}">
                    <!-- store cache uuid for reload filter obj. -->
                </center>
            </div>
            <br>

            <div>
                <table id="tabs" class="no_border">
                    <tr>
                        <td style="width: 20%; min-width: 150px;" valign="top">
                            <center><label>Group of objects</label></center>
                            <br>
                            <div style="max-height: 300px;" class="scrollable-table">
                                <table id="group_table" class="border">
                                    <thead>
                                        <tr>
                                            <th class="group_th" style="width: 20px;"></th>
                                            <th class="group_th">Group</th>
                                            <th class="group_th" style="width: 5%;">Number</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for group, obj in groups | dictsort %}

                                        <tr data-row-id="{{ loop.index0 }}">
                                            <td>
                                                <center>
                                                    <input type="checkbox" name="use_group" value="{{ group }}"
                                                        title="Include group of objects to scheduler." {% if group in
                                                        use_group %}checked{% endif %} style="min-width: 20px;">
                                                </center>
                                            </td>
                                            <td>{{ group }}</td>
                                            <td>{{ obj }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            <br>
                            <div class="button-group">
                                <center>
                                    <button type="button" name="all" title="Select all objects groups."
                                        onclick="select_all()">Select
                                        all</button>
                                    <button type="button" name="none" title="Deselect all groups."
                                        onclick="select_none()">Select
                                        none</button>
                                </center>
                            </div>
                        </td>
                        <td style="width: 50px;">
                            <center>
                                <input type="checkbox" name="individual" id="individual" value="checked"
                                    title="Apply inidividual object constraints." {% if indiv %}checked{% endif %}
                                    style="min-width: 20px;">
                                <label for="individual">Individual<br>&nbsp;&nbspconstraints</label>
                                <br>
                                <br>
                                <button type="submit" name="filter" id="filter" title="Filter objects."
                                    onclick="return checkGroup()">Filter</button>
                            </center>
                        </td>
                        <td style="min-width: 300px;" valign="top">
                            <div style="max-height: 400px;" class="scrollable-table">
                                <table id="obj_table" style="max-height: 300px;" class="border">
                                    <thead>
                                        <th class="obj_th"></th>
                                        <th class="obj_th">Target</th>
                                        <th class="obj_th">RA</th>
                                        <th class="obj_th">DEC</th>
                                        <th class="obj_th">Mag</th>
                                        <th class="obj_th">ExpTime</th>
                                        <th class="obj_th">Number</th>
                                        {% if obs %}<th class="obj_th">Observable</th>{% endif %}
                                        <th class="obj_th">Priority</th>
                                        <th class="obj_th">OtherRequests</th>
                                    </thead>
                                    {% for row in objects %}
                                    <tr data-row-id="{{ loop.index0 }}">
                                        <td class="actions">
                                            <button type="submit" class="modify-row" name="add_{{ loop.index0 }}"
                                                title="Add">
                                                <img src="{{ url_for('static',filename='add.svg') }}" alt="add">
                                            </button>
                                            <button type="submit" class="modify-row" name="preview_{{ loop.index0 }}"
                                                title="Altitude graph" onclick="return checkTwilight()"
                                                formtarget=”_blank”>
                                                <img src="{{ url_for('static',filename='preview.svg') }}" alt="preview">
                                            </button>

                                        </td>
                                        <td>{{ row.Target }}</td>
                                        <td>{{ row.RA.split('.')[0] }}</td>
                                        <td>{{ row.DEC.split('.')[0] }}</td>
                                        <td>{% if row.Mag is number %}
                                            {{ row.Mag | round(1) }}
                                            {% else %}
                                            {{ row.Mag }}
                                            {% endif %}
                                        </td>
                                        <td>{{ row.ExpTime }}</td>
                                        <td>{{ row.Number }}</td>
                                        {% if obs %}
                                        <td>{{ obs[loop.index0] }}</td>
                                        {% endif %}
                                        <td>{{ row.Priority }}</td>
                                        <td>{{ row.OtherRequests }}</td>
                                    </tr>
                                    {% endfor %}
                                </table>
                            </div>
                        </td>
                    </tr>
                </table>

            </div>
            <br>


            <div>
                <label for="night">Scheduling night:</label>
                <input type="date" name="night" id="night" value="{{ night }}"
                    title="Local date of beginning of night.">&nbsp;&nbsp;&nbsp;&nbsp;
                <label for="start">Observation start</label>
                <input type="time" name="start" id="start" value="{{ start }}" title="Time for observations start.">
                <button type="submit" name="twilight" id="twilight" title="Set time to astronomical twilight."
                    onclick="return checkTwilight()">Astronomical twilight</button>
            </div>

            <br>
            <div>
                <center>
                    <label for="save-name">Name of scheduler</label>
                    <input type="text" name="save-name" id="save-name" title="Name of schedule to save.">
                    <button type="submit" name="save" id="save" onclick="return checkSave()" title="Save schedule." {%
                        if not code %}disabled style="background-color:gray; color: black; cursor: default;" {% endif
                        %}>Save schedule</button>
                    <button type="submit" name="download" id="download" title="Download schedule as CSV." {% if not code
                        %}disabled style="background-color:gray; color: black; cursor: default;" {% endif %}>Download
                        CSV</button>
                    <button type="submit" name="json" id="json" title="Download schedule as JSON." {% if not code
                        %}disabled style="background-color:gray; color: black; cursor: default;" {% endif %}>Download
                        JSON</button>
                    <button type="submit" name="batch" id="batch" title="Download schedule as JSON for Batch." {% if not code
                        %}disabled style="background-color:gray; color: black; cursor: default;" {% endif %}>Download
                        Batch</button>
                </center>
            </div>


            <!-- table with observable obj -->
            <center>
                <h2>Objects for observations</h2>
            </center>
            <table id="shedule_table">
                <thead>
                    <th></th>
                    <th></th>
                    <th>Target</th>
                    <th>RA</th>
                    <th>DEC</th>
                    <th>Mag</th>
                    <th>ExpTime</th>
                    <th>Number</th>
                    <th>Notes</th>
                    <th>Start</th>
                    <th>End</th>
                    <th>Altitude</th>
                    <th>Airmass</th>
                    <th>Azimut</th>
                    <th>Position</th>
                </thead>
                {% for row in schedule %}
                <tr data-row-id="{{ loop.index0 }}">
                    <td class="actions">
                        <button type="button" class="modify-row" name="delete_{{ row.index }}" title="Delete target"
                            onclick="deleteRow(this)">
                            <img src="{{ url_for('static',filename='delete.svg') }}" alt="delete">
                        </button>
                        <button type="button" class="modify-row" name="up_{{ row.index }}" title="Move up"
                            onclick="moveUp(this)">
                            <img src="{{ url_for('static',filename='up.svg') }}" alt="up">
                        </button>
                        <button type="button" class="modify-row" name="down_{{ row.index }}" title="Move down"
                            onclick="moveDown(this)">
                            <img src="{{ url_for('static',filename='down.svg') }}" alt="down">
                        </button>
                    </td>
                    <td>
                        {{ row.index }}
                        <input type="hidden" name="id" id="id" value="{{ row.index }}">
                    </td>
                    <td>{{ row.Target }}</td>
                    <td>{{ row.RA.split('.')[0] }}</td>
                    <td>{{ row.DEC.split('.')[0] }}</td>
                    <td>{% if row.Mag is number %}
                        {{ row.Mag | round(1) }}
                        {% else %}
                        {{ row.Mag }}
                        {% endif %}
                    </td>
                    <!-- exptime, number, remarks editable -->
                    <td>
                        <input type="text" name="exp" value="{{ row.ExpTime }}" class="tab-input"
                            title="Exposure time in seconds.">
                    </td>
                    <td>
                        <input type="text" name="number" value="{{ row.Number }}" class="tab-input"
                            title="Number of exposures.">
                    </td>
                    <td>
                        <input type="text" name="notes" value="{{ row.Remarks }}" class="tab-input"
                            title="Notes to observation (e.g. IC, photometry).">
                    </td>
                    <!-- using td text to allow select and copy whole tab
                     inputs to store data -->
                    <!-- <td contenteditable="true" oninput="updateHiddenInput(this)">
                        <input type="hidden" name="exp" value="{{ row.ExpTime }}" class="tab-input">
                        {{ row.ExpTime }}
                    </td>
                    <td contenteditable="true" oninput="updateHiddenInput(this)">
                        <input type="hidden" name="number" value="{{ row.Number }}" class="tab-input">
                        {{ row.Number }}
                    </td>
                    <td contenteditable="true" oninput="updateHiddenInput(this)">
                        <input type="hidden" name="notes" value="{{ row.Remarks }}" class="tab-input">
                        {{ row.Remarks }}
                    </td> -->
                    <!-- <td>{{ row.ExpTime }}</td>
                    <td>{{ row.Number }}</td>
                    <td>{{ row.Remarks }}</td>                     -->
                    <td>{% if row.Start %}
                        {{row.Start.split()[1][:row.Start.split()[1].rfind(':')] }}
                        {% endif %}
                    </td>
                    <td>{% if row.End %}
                        {{ row.End.split()[1][:row.End.split()[1].rfind(':')] }}
                        {% endif %}
                    </td>
                    <td>{% if row.Altitude %}
                        {{ row.Altitude | float() | round(0) | int() }}
                        {% endif %}
                    </td>
                    <td>{% if row.Airmass %}
                        {{ row.Airmass | float() | round(1) }}
                        {% endif %}
                    </td>
                    <td>{% if row.Azimut %}
                        {{ row.Azimut | float() | round(0) | int() }}
                        {% endif %}
                    </td>
                    <td {% if row.Position=='-' %}style="background-color: red; " {% endif %}>
                        <span style="display: inline-block; width: 30px">{{ row.Position }}</span>
                        {% if row.Position %}
                        <button type="button" class="modify-row" name="plot" title="Plot telescope limits"
                            onclick="window.open('{{ url_for('limits', ha0 = row.ha0, ha1 = row.ha1, dec=row.de, title=row.Target) }}', '_blank')"
                            formtarget=”_blank”>
                            <img src="{{ url_for('static',filename='preview.svg') }}" alt="preview">
                        </button>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </table>
            <br>
            <center>
                <button type="submit" name="calc" id="calc" onclick="return rerun()" {% if not code %}disabled
                    style="background-color:gray; color: black; cursor: default;" {% endif %}
                    title="Re-calculate observing times and possitions of targets.">Re-calculate</button>
                <button type="submit" name="run" id="run" onclick="return rerun()" {% if not code %}disabled
                    style="background-color:gray; color: black; cursor: default;" {% endif %}
                    title="Run scheduler with objects in the schedule. It will create new schedule and any unsaved changes will be losed!">Re-schedule</button>
            </center>
        </form>

        {% if alt_plot %}
        <div>
            <img width="40%" src='data:image/png;base64,{{ alt_plot }}' alt="Altitude plot"
                onclick="img64('{{ alt_plot }}')">
            <img width="40%" src='data:image/png;base64,{{ sky }}' alt="Sky plot" onclick="img64('{{ sky }}')">
        </div>
        {% endif %}

        {% if modify %}
        <script>
            //load schedule for save&modify
            document.getElementById("load").click();
        </script>
        {% endif %}

        <script>
            // sorting groups table

            function sortTable(f, n) {
                // get all rows from table
                let rows = $('#group_table tbody  tr').get();

                rows.sort(function (a, b) {
                    // algorithm for sorting

                    let A = getVal(a);
                    let B = getVal(b);

                    if (A < B) {
                        return -1 * f;
                    }
                    if (A > B) {
                        return 1 * f;
                    }
                    return 0;
                });

                function getVal(elm) {
                    let v = $(elm).children('td').eq(n).text().toUpperCase();
                    if ($.isNumeric(v)) {
                        v = parseFloat(v, 10);
                    }
                    return v;
                }

                $.each(rows, function (index, row) {
                    $('#group_table').children('tbody').append(row);
                });
            }
            let f_sl = 1;

            $(function () {

                $("#group_table th").click(function () {
                    var headers = document.getElementsByClassName("group_th");    // get header
                    var old = -1;
                    for (var i = 0; i < headers.length; i++) {
                        // remove symbol from old sorting col and save its index
                        if (headers[i].innerHTML.indexOf('▼') > 0) {
                            old = i;
                            headers[i].innerHTML = headers[i].innerHTML.slice(0, headers[i].innerHTML.indexOf('▼') - 1);
                            break;
                        }
                        if (headers[i].innerHTML.indexOf('▲') > 0) {
                            old = i;
                            headers[i].innerHTML = headers[i].innerHTML.slice(0, headers[i].innerHTML.indexOf('▲') - 1);
                            break;
                        }
                    }

                    let n = $(this).prevAll().length

                    if (old === n) {
                        f_sl *= -1;   // resort old col
                    }
                    else {
                        f_sl = 1;     // sorting using new col
                    }

                    sortTable(f_sl, n)

                    // add symbol to header
                    if (f_sl === -1)
                        $(this).text($(this).text() + " ▼")
                    else
                        $(this).text($(this).text() + " ▲")

                });

            });
        </script>
        <script>
            // sorting object table

            function sortObjTable(f, n) {
                // get all rows from table
                let rows = $('#obj_table tbody  tr').get();

                rows.sort(function (a, b) {
                    // algorithm for sorting

                    let A = getVal(a);
                    let B = getVal(b);

                    if (A < B) {
                        return -1 * f;
                    }
                    if (A > B) {
                        return 1 * f;
                    }
                    return 0;
                });

                function getVal(elm) {
                    let v = $(elm).children('td').eq(n).text().toUpperCase();
                    if (n === 1) {
                        return v.replace(" ", "").replace("-", "").replace("_", "");   //col with target name
                    }
                    if ($.isNumeric(v)) {
                        v = parseFloat(v, 10);
                    }
                    else if ($.isNumeric(v.slice(0, 3))) {
                        v = parseFloat(v.slice(0, 3), 10);    // RA/DEC -> number from 1st part
                    }
                    else if ($.isNumeric(v.slice(0, 2))) {
                        v = parseFloat(v.slice(0, 2), 10);     // RA/DEC -> number from 1st part
                    }
                    else if (v === 'SERIES') {
                        v = 50;                                 // number of exp.=series -> set some big number
                    }
                    return v;
                }

                $.each(rows, function (index, row) {
                    $('#obj_table').children('tbody').append(row);
                });
            }
            let f_slO = 1;

            $(function () {

                $("#obj_table th").click(function () {
                    var headers = document.getElementsByClassName("obj_th");    // get header
                    var old = -1;
                    for (var i = 0; i < headers.length; i++) {
                        // remove symbol from old sorting col and save its index
                        if (headers[i].innerHTML.indexOf('▼') > 0) {
                            old = i;
                            headers[i].innerHTML = headers[i].innerHTML.slice(0, headers[i].innerHTML.indexOf('▼') - 1);
                            break;
                        }
                        if (headers[i].innerHTML.indexOf('▲') > 0) {
                            old = i;
                            headers[i].innerHTML = headers[i].innerHTML.slice(0, headers[i].innerHTML.indexOf('▲') - 1);
                            break;
                        }
                    }

                    let n = $(this).prevAll().length

                    if (old === n) {
                        f_slO *= -1;   // resort old col
                    }
                    else {
                        f_slO = 1;     // sorting using new col
                    }

                    sortObjTable(f_slO, n)

                    // add symbol to header
                    if (f_slO === -1)
                        $(this).text($(this).text() + " ▼")
                    else
                        $(this).text($(this).text() + " ▲")

                });

            });
        </script>

    </body>

</html>