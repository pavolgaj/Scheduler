<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Modify schedule</title>
        <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
        <script src="{{ url_for('static', filename='jquery.min.js') }}"></script>
        <link href="{{ url_for('static', filename='select2.min.css') }}" rel="stylesheet" />
        <script src="{{ url_for('static', filename='select2.min.js') }}"></script>
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 50px;
            }

            table {
                font-family: arial, sans-serif;
                border-collapse: separate;
                /* Don't collapse */
                border-spacing: 0;
                width: 100%;
            }

            td,
            th {
                border: 1px solid black;
                text-align: left;
                padding: 8px;
                white-space: nowrap;
            }

            tr:nth-child(even) {
                background-color: #dddddd;
            }

            label {
                margin-bottom: 8px;
                font-weight: bold;
            }

            select {
                padding: 10px;
                border-radius: 5px;
                width: 20%;
                min-width: 100px;
            }

            input {
                padding: 10px;
                border-radius: 5px;
                width: 20%;
                min-width: 100px;
                max-width: 200px;
            }

            button {
                padding: 10px 20px;
                border: none;
                border-radius: 5px;
                background-color: #333;
                color: white;
                cursor: pointer;
            }

            button:hover {
                background-color: #555;
            }

            .actions {
                width: 45px;
                display: table-cel;
                font-size: 0em;
                justify-content: left;
            }

            .modify-row {
                padding: 0px;
                width: 20px;
                height: 20px;
                background-color: silver;
                border-color: black;
                border-width: 1px;
                border-radius: 5px;
                margin-right: 2px;
            }

            .modify-row img {
                height: 17px;
                display: block;
                margin-left: auto;
                margin-right: auto;
            }

            .scrollable-table {
                overflow-y: auto;
                /* Enable vertical scrolling */
            }

            thead th {
                /* fix header */
                position: sticky;
                top: 0;
                /* Stick the header to the top */
                z-index: 1;
                /* Ensure the header stays on top */
                background-color: white;
            }

            .fix {
                /* fix 1st col */
                position: sticky;
                left: 0;
                z-index: 0;
                background-color: inherit;
                /* same color as row */
            }

            .no_border td {
                border: none;
            }

            .border td {
                border: 1px solid black;
            }

            /* hide border for inputs in table */
            .tab-input {
                width: 100%;
                box-sizing: border-box;
                border: none;
                background-color: transparent;
                /* Make background transparent */
                font-family: inherit;
                /* Inherit font styles from the table */
                font-size: inherit;
                padding: 0;
                margin: 0;
                min-width: 10px;
            }

            img {
                cursor: pointer;
            }

            .wrap {
                word-wrap: break-word;
                max-width: 300px;
                white-space: wrap;
            }
        </style>
        <script>
            // Function to move a row up
            function moveUp(btn) {
                var row = btn.parentNode.parentNode;
                var previousRow = row.previousElementSibling;
                if (previousRow && previousRow.tagName === 'TR') {
                    row.parentNode.insertBefore(row, previousRow);
                }

                var calc = document.getElementById('calc_test');
                calc.value = 0;
            }

            // Function to move a row up by 5 lines
            function moveUp5(btn) {
                var row = btn.parentNode.parentNode;
                var previousRow = row;

                for (var i = 0; i < 5; i++) {
                    if (previousRow && previousRow.tagName === 'TR') {                        
                        if (previousRow.previousElementSibling==null) break;
                        previousRow = previousRow.previousElementSibling;
                    } else {
                        break; // Stop if there are no more rows above
                    }
                }
                row.parentNode.insertBefore(row, previousRow);

                var calc = document.getElementById('calc_test');
                calc.value = 0;
            }

            // Function to move a row down
            function moveDown(btn) {
                var row = btn.parentNode.parentNode;
                var nextRow = row.nextElementSibling;
                if (nextRow && nextRow.tagName === 'TR') {
                    row.parentNode.insertBefore(nextRow, row);
                }

                var calc = document.getElementById('calc_test');
                calc.value = 0;
            }

            // Function to move a row down by 5 lines
            function moveDown5(btn) {
                var row = btn.parentNode.parentNode;
                var nextRow = row;

                for (var i = 0; i < 6; i++) {
                    if (nextRow && nextRow.tagName === 'TR') {                        
                        //if (nextRow.nextElementSibling==null) break;
                        nextRow = nextRow.nextElementSibling;
                    } else {
                        break; // Stop if there are no more rows above
                    }
                }
                row.parentNode.insertBefore(row,nextRow);

                var calc = document.getElementById('calc_test');
                calc.value = 0;
            }


            // Function to delete a row
            function deleteRow(btn) {
                var row = btn.parentNode.parentNode;
                row.parentNode.removeChild(row);

                var calc = document.getElementById('calc_test');
                calc.value = 0;
            }

            // check if obj. group is selected
            function checkGroup() {
                const checkboxes = document.querySelectorAll('input[type="checkbox"]');
                let isChecked = false;

                checkboxes.forEach((checkbox) => {
                    if (checkbox.checked) {
                        isChecked = true;
                    }
                });
                if (!isChecked) {
                    alert('NO group of object is selected!');
                    return false;
                }
                else {
                    popup();
                }
                return true;
            }

            // check if name is given
            function checkSave() {
                var calc = document.getElementById('calc_test');

                if (calc.value == 0) {
                    alert('Recalculate schedule!');
                    return false;
                }

                var name = document.getElementById('save-name');
                if (!name.value) {
                    alert('Name of schedule is missing!');
                    return false;
                }
                return true;
            }
            // check if night is given
            function checkTwilight() {
                var night = document.getElementById('night');
                if (!night.value) {
                    alert('Date of scheduling night is missing!');
                    return false;
                }
                return true;
            }
            // check if night and time are given
            function checkStart() {
                var night = document.getElementById('night');
                if (!night.value) {
                    alert('Date of scheduling night is missing!');
                    return false;
                }
                var start = document.getElementById('start');
                if (!start.value) {
                    alert('Observations start is missing!');
                    return false;
                }
                return true;
            }

            function popup() {
                //show info about running, not block server
                var myDialog = document.createElement("dialog");
                document.body.appendChild(myDialog);
                var text = document.createTextNode(" Please, wait...");
                myDialog.appendChild(text);
                myDialog.showModal();
            }

            function isInt(str) {
                // check if string is integer
                return (parseInt(str) == str);
            }

            function checkNum() {
                //check values in inputs (number and exp)                
                let valid = true;

                var inputs = document.getElementsByName('exp');
                inputs.forEach((inp) => {
                    if (!isInt(inp.value)) {
                        valid = false;
                    }
                    else if (inp.value<0) {
                        valid = false;
                    }
                });
                if (!valid) {
                    alert('Exposure time should be positive number!');
                    return valid;
                }

                inputs = document.getElementsByName('number');
                inputs.forEach((inp) => {
                    if (!isInt(inp.value)) {
                        valid = false;
                    }
                    else if (inp.value<0) {
                        valid = false;
                    }
                });
                if (!valid) {
                    alert('Number of exposure should be positive number!');
                    return valid;
                }
                return valid;
            }

            function rerun() {
                //make some checks before rerun (recalc and reschedule)
                var check = checkStart();
                var valid = checkNum();

                if (check && valid) {
                    popup();
                }
                return (check && valid);
            }

            function recalc() {
                //check allocated time before recalc
                var allocTime = 0;

                exps = document.getElementsByName('exp');
                nums = document.getElementsByName('number');
                for (var i = 0; i < exps.length; i++) {
                    allocTime += exps[i].value * nums[i].value + 2*60;  //add time for slew
                }

                var totTime = document.getElementById('total_time').value;

                if (totTime == 16) {
                    if (confirm('Total allocated time is ' + Math.round(allocTime / 3600).toFixed(2) + ' hours. Run calculation only if you have available enough time!') == false) {
                        return false;
                    }
                }

                if (allocTime > totTime * 3600 - 3600) {
                    alert('Schedule is too long! Total allocated time is longer than available.');
                    return false;
                }

                return rerun();
            }

            // function add_after() {
            //     tab=document.getElementById('schedule_table');
            //     rows=tab.rows.length-1;

            //     ord=prompt("Add target after line",rows);
            //     if (ord != null) {
            //         if (! isInt(ord)) ord=rows;

            //         if (ord>rows) ord=rows;
            //         else if (ord<0) ord=0;   
            //         document.getElementById('after').value=ord;                 
            //     }

            //     return (ord != null);
            // }

            function modify() {
                //on input change -> need recalc
                var calc = document.getElementById('calc_test');
                calc.value = 0;

                var night = document.getElementById('night').value;
                start = document.getElementById('start').value;

                if (night && start) {
                    dt0=new Date(night+'T'+start0+':00Z');
                    dt=new Date(night+'T'+start+':00Z');

                    if (dt0-new Date(night+'T00:00:00Z')>0.5*86400*1000) {
                        dt0=new Date(dt0-86400*1000);
                    }
                    if (dt-new Date(night+'T00:00:00Z')>0.5*86400*1000) {
                        dt=new Date(dt-86400*1000);
                    }

                    diff=dt-dt0;

                    var totTime = document.getElementById('total_time').value;

                    if (totTime != 16) {
                        document.getElementById('total_time').value=totTime-diff/1000/3600;
                        start0=start;
                    }
                }
            }

            function select_all() {
                //select all groups
                checkboxes = document.getElementsByName('use_group');
                for (var i = 0; i < checkboxes.length; i++) {
                    checkboxes[i].checked = true;
                }
            }
            function select_none() {
                //select none groups
                checkboxes = document.getElementsByName('use_group');
                for (var i = 0; i < checkboxes.length; i++) {
                    checkboxes[i].checked = false;
                }
            }
            function delete_confirm() {
                //confirm delete schedule
                var name = document.getElementById('name');
                var text = name.value;
                return confirm("Delete selected schedule '" + text + "'?");
            }

            // function updateHiddenInput(cell) {
            //     //update inputs after td change
            //     //var hiddenInput = cell.querySelector('input[type="hidden"]');
            //     var hiddenInput = cell.querySelector('input');
            //     hiddenInput.value = cell.innerText.trim();
            // }

            // DISABLE submit form on ENTER
            document.addEventListener('DOMContentLoaded', (event) => {
                const form = document.querySelector('form');
                form.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                    }
                });
            });

            //Display a base64 URL inside an iframe in another window.
            //for chrome etc. (a href not work!)
            function debugBase64(base64URL) {
                var win = window.open();
                win.document.write('<iframe src="' + base64URL + '" frameborder="0" style="border:0; top:0px; left:0px; bottom:0px; right:0px; width:100%; height:100%;" allowfullscreen></iframe>');
            }

            //This will open an image in a new window
            function img64(data) {
                debugBase64("data:image/png;base64," + data);
            }   
        </script>

    </head>

    <body>        
        <form method="post" id="main-form">
            <input type="hidden" name="calc_test" id="calc_test" value="{{ calc }}">
            <input type="hidden" name="total_time" id="total_time" value="{{ total_time }}"> 
            <div>
                <center>
                    <label for="name">Name of schedule</label>
                    <select name="name" id="name" title="Names of available schedules to modify.">
                        {% for sch in schedules %}
                        <option value="{{ sch }}" {% if name==sch %}selected{% endif %}>{{ sch }}</option>
                        {% endfor %}
                    </select>
                    <button type="submit" name="load" id="load" onclick="popup()" title="Load schedule." {% if not
                        schedules %}disabled style="background-color:gray; color: black; cursor: default;" {% endif
                        %}>Load
                        schedule</button>
                    <button type="submit" name="new" id="new" title="Create empty schedule.">New schedule</button>
                    <button type="submit" name="delete" id="delete" title="Delete selected schedule."
                        onclick="return delete_confirm()" {% if not schedules %}disabled
                        style="background-color:gray; color: black; cursor: default;" {% endif %}>Delete
                        schedule</button>
                    <input type="hidden" name="code" id="code" value="{{ code }}">
                    <!-- store cache uuid for reload df -->
                    <input type="hidden" name="codeF" id="codeF" value="{{ codeF }}">
                    <!-- store cache uuid for reload filter obj. -->
                    <input type="hidden" name="codeObj" id="codeObj" value="{{ codeObj }}">
                </center>
            </div>
            <br>

            <div>
                <table id="tabs" class="no_border">
                    <tr>
                        <td style="width: 20%; min-width: 150px;" valign="top">
                            <center><label>Observing programs</label></center>
                            <br>
                            <div style="max-height: 300px;" class="scrollable-table">
                                <table id="group_table" class="border">
                                    <thead>
                                        <tr>
                                            <th class="group_th" style="width: 20px;"></th>
                                            <th class="group_th">Program</th>
                                            <th class="group_th" style="width: 5%;">Number</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for group, obj in groups | dictsort %}

                                        <tr data-row-id="{{ loop.index0 }}">
                                            <td>
                                                <center>
                                                    <input type="checkbox" name="use_group" value="{{ group }}"
                                                        title="Include objects in program." {% if group in use_group
                                                        %}checked{% endif %} style="min-width: 20px;">
                                                </center>
                                            </td>
                                            <td class="wrap">{{ group }}
                                                <button type="button" class="modify-row" name="info"
                                                    title="Info about observing program"
                                                    onclick="window.open('{{ url_for('proposal_info', name = group) }}', '_blank')"
                                                    formtarget=”_blank”>
                                                    <img src="{{ url_for('static',filename='info.svg') }}"
                                                        alt="preview">
                                                </button>
                                            </td>
                                            <td>{{ obj }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            <br>
                            <div class="button-group">
                                <center>
                                    <button type="button" name="all" title="Select all objects groups."
                                        onclick="select_all()">Select
                                        all</button>
                                    <button type="button" name="none" title="Deselect all groups."
                                        onclick="select_none()">Select
                                        none</button>
                                </center>
                            </div>
                        </td>
                        <td style="width: 50px;">
                            <center>
                                <label for="condi">Observing conditions</label><br>
                                <select id="condi" name="condi"
                                    title="Required observing conditions (clouds, seeing, wind etc.)"
                                    placeholder="Required observing conditions (clouds, seeing, wind etc.)">
                                    <option value="all" {% if condi=='all' %}selected{% endif %}>All</option>
                                    <option value="excellent" {% if condi=='excellent' %}selected{% endif %}>Excellent
                                    </option>
                                    <option value="good" {% if condi=='good' %}selected{% endif %}>Good (normal)
                                    </option>
                                    <option value="poor" {% if condi=='poor' %}selected{% endif %}>Poor</option>
                                    <option value="na" {% if condi=='na' %}selected{% endif %}>Not given</option>
                                </select><br><br>
                                <label for="freq">Observation frequency</label><br>
                                <select id="freq" name="freq" title="Frequency of observations.">
                                    <option value="all" {% if freq=='all' %}selected{% endif %}>All</option>
                                    <option value="everynight" {% if freq=='everynight' %}selected{% endif %}>Every night</option>
                                    <option value="twiceweek" {% if freq=='twiceweek' %}selected{% endif %}>Twice a week</option>
                                    <option value="onceweek" {% if freq=='onceweek' %}selected{% endif %}>Once a week</option>
                                    <option value="twicemonth" {% if freq=='twicemonth' %}selected{% endif %}>Twice a month</option>
                                    <option value="oncemonth" {% if freq=='oncemonth' %}selected{% endif %}>Once a month</option>
                                    <option value="unspecified" {% if freq=='unspecified' %}selected{% endif %}>Unspecified</option>
                                </select><br><br>
                                <input type="checkbox" name="individual" id="individual" value="checked"
                                    title="Apply inidividual object constraints." {% if indiv %}checked{% endif %}
                                    style="min-width: 20px;">
                                <label for="individual">Individual<br>&nbsp;&nbspconstraints</label>
                                <br>
                                <br>
                                <button type="submit" name="filter" id="filter" title="Filter objects."
                                    onclick="return checkGroup()">Filter</button>
                            </center>
                        </td>
                        <td style="min-width: 300px;" valign="top">
                            <div style="max-height: 400px;" class="scrollable-table">
                                <table id="obj_table" style="max-height: 300px;" class="border">
                                    <thead>
                                        <th class="obj_th"></th>
                                        <th class="obj_th">Target</th>
                                        <th class="obj_th">RA</th>
                                        <th class="obj_th">DEC</th>
                                        <th class="obj_th">Mag</th>
                                        <th class="obj_th">ExpTime</th>
                                        <th class="obj_th">Number</th>
                                        {% if obs %}<th class="obj_th">Observable</th>{% endif %}
                                        <th class="obj_th">Priority</th>
                                        <th class="obj_th">Frequency</th>
                                        <th class="obj_th">OtherRequests</th>
                                    </thead>
                                    {% for row in objects %}
                                    <tr data-row-id="{{ loop.index0 }}"
title="Group: {{ row.Type }}
Supervisor: {{ row.Supervisor }}
Conditions: {{ row.Conditions }}">
                                        <td class="actions">
                                            <button type="submit" class="modify-row" name="add_{{ loop.index0 }}"
                                                title="Add" > <!-- onclick='return add_after()' -->
                                                <img src="{{ url_for('static',filename='add.svg') }}" alt="add">
                                            </button>
                                            <button type="submit" class="modify-row" name="preview_{{ loop.index0 }}"
                                                title="Altitude graph" onclick="return checkTwilight()"
                                                formtarget=”_blank”>
                                                <img src="{{ url_for('static',filename='preview.svg') }}" alt="preview">
                                            </button>

                                        </td>
                                        <td>{{ row.Target }}
                                            <button type="button" class="modify-row" name="info"
                                                title="Info about target"
                                                onclick="window.open('{{ url_for('object_info', name = row.Target) }}', '_blank')"
                                                formtarget=”_blank”>
                                                <img src="{{ url_for('static',filename='info.svg') }}" alt="preview">
                                            </button>
                                        </td>
                                        <td>{{ row.RA.split('.')[0] }}</td>
                                        <td>{{ row.DEC.split('.')[0] }}</td>
                                        <td>{% if row.Mag is number %}
                                            {{ row.Mag | round(1) }}
                                            {% else %}
                                            {{ row.Mag }}
                                            {% endif %}
                                        </td>
                                        <td>{{ row.ExpTime }}</td>
                                        <td>{{ row.Number }}</td>
                                        {% if obs %}
                                        <td>{{ obs[loop.index0] }}</td>
                                        {% endif %}
                                        <td>{{ row.Priority }}</td>
                                        <td>{{ row.Frequency }}</td>
                                        <td>{{ row.OtherRequests }}</td>
                                    </tr>
                                    {% endfor %}
                                </table>
                            </div>
                        </td>
                    </tr>
                </table>


                <br>
                <label>Individual target</label>
                <select name="obj" id="obj" title="List of all targets. Observability NOT checked!">
                    {% for obj in all_obj %}
                    <option value="{{ obj[0] }}" {% if indObj==obj[0] %}selected{% endif %}>{{ obj[1]['name'] }}
                    </option>
                    {% endfor %}
                </select>
                <button type="submit" name="indiv" {% if not codeObj %}disabled
                    style="background-color:gray; color: black; cursor: default;" {% endif %}
                    title="Add selected target to the schedule.">Add</button>   <!-- onclick='return add_after()' -->
                &nbsp;&nbsp;&nbsp;
                <button type="submit" name="gap" title="Add gap/delay to the schedule.">Add gap</button>

            </div>
            <!-- <input type="hidden" id="after" name="after"> -->
            <br>

            <div>
                <label for="night">Scheduling night:</label>
                <input type="date" name="night" id="night" value="{{ night }}" title="Local date of beginning of night."
                    onchange="modify()">&nbsp;&nbsp;&nbsp;&nbsp;
                <label for="start">Observation start</label>
                <input type="time" name="start" id="start" value="{{ start }}" title="Time for observations start."
                    onchange="modify()">
                <script>
                    var start0="{{ start }}";
                </script>
                <button type="submit" name="twilight" id="twilight" title="Set time to astronomical twilight."
                    onclick="return checkTwilight()">Astronomical twilight</button>
            </div>

            <br>
            <hr>
            <br>
            <div>
                <center>
                    <label for="save-name">Name of schedule</label>
                    <input type="text" name="save-name" id="save-name" title="Name of schedule to save on server."
                        placeholder="Name of schedule to save">
                    <button type="submit" name="save" id="save" onclick="return checkSave()" title="Save schedule." {%
                        if not code %}disabled style="background-color:gray; color: black; cursor: default;" {% endif
                        %}>Save schedule</button>
                    <button type="submit" name="download" id="download" title="Download schedule as CSV." {% if not code
                        %}disabled style="background-color:gray; color: black; cursor: default;" {% endif %}>Download
                        CSV</button>
                    <button type="submit" name="json" id="json" title="Download schedule as JSON." {% if not code
                        %}disabled style="background-color:gray; color: black; cursor: default;" {% endif %}>Download
                        JSON</button>
                    <button type="submit" name="batch" id="batch" title="Download schedule as JSON for Batch." {% if not
                        code %}disabled style="background-color:gray; color: black; cursor: default;" {% endif
                        %}>Download
                        Batch</button>
                </center>
            </div>


            <!-- table with observable obj -->
            <center>
                <h2>Objects for observations</h2>
                <h3 style="color: red;">Modifications of this table (removing or reordering rows) are applied only after running "Recalculate" or "Reschedule". Adding new target before it cancels these changes!</h3>
            </center>
            <table id="schedule_table">
                <thead>
                    <th></th>
                    <th></th>
                    <th>Target</th>
                    <th>RA</th>
                    <th>DEC</th>
                    <th>Mag</th>
                    <th>ExpTime</th>
                    <th>Number</th>
                    <th>Notes</th>
                    <th>Start</th>
                    <th>End</th>
                    <th>Priority</th>
                    <th>Altitude</th>
                    <th>Airmass</th>
                    <th>Azimuth</th>
                    <th>MoonDist</th>
                    <th>Position</th>
                </thead>
                {% for row in schedule %}
                <tr data-row-id="{{ loop.index0 }}"
title="Group: {{ row._Type }}
Supervisor: {{ row._Supervisor }}
Conditions: {{ row._Conditions }}
Frequency: {{ row._Frequency }}
OtherRequests: {{ row._OtherRequests }}">
                    <td class="actions">
                        <button type="button" class="modify-row" name="delete_{{ row.index }}" title="Delete target"
                            onclick="deleteRow(this)">
                            <img src="{{ url_for('static',filename='delete.svg') }}" alt="delete">
                        </button>
                        <button type="button" class="modify-row" name="up_{{ row.index }}" title="Move up"
                            onclick="moveUp(this)">
                            <img src="{{ url_for('static',filename='up.svg') }}" alt="up">
                        </button>
                         <button type="button" class="modify-row" name="down_{{ row.index }}" title="Move down"
                            onclick="moveDown(this)">
                            <img src="{{ url_for('static',filename='down.svg') }}" alt="down">
                        </button>
                        <button type="button" class="modify-row" name="up5_{{ row.index }}" title="Move up by 5 rows"
                            onclick="moveUp5(this)">
                            <img src="{{ url_for('static',filename='up5.svg') }}" alt="up5">
                        </button>                       
                        <button type="button" class="modify-row" name="down5_{{ row.index }}" title="Move down by 5 rows"
                            onclick="moveDown5(this)">
                            <img src="{{ url_for('static',filename='down5.svg') }}" alt="down5">
                        </button>
                    </td>
                    <td>
                        {{ row.index }}
                        <input type="hidden" name="id" id="id" value="{{ row.index }}">
                    </td>
                    <td>{{ row.Target }}
                        {% if not row.Target=='Delay' %}
                        <button type="button" class="modify-row" name="info" title="Info about target"
                            onclick="window.open('{{ url_for('object_info', name = row.Target) }}', '_blank')"
                            formtarget=”_blank”>
                            <img src="{{ url_for('static',filename='info.svg') }}" alt="preview">
                        </button>
                        {% endif %}
                    </td>
                    <td>{% if not row.Target=='Delay' %}{{ row.RA.split('.')[0] }}{% endif %}</td>
                    <td>{% if not row.Target=='Delay' %}{{ row.DEC.split('.')[0] }}{% endif %}</td>
                    <td>{% if row.Mag is number %}
                        {{ row.Mag | round(1) }}
                        {% else %}
                        {{ row.Mag }}
                        {% endif %}
                    </td>
                    <!-- exptime, number, remarks editable -->
                    <td>
                        <input type="text" name="exp" value="{{ row.ExpTime }}" class="tab-input"
                            title="Exposure time in seconds." onchange="modify()">
                    </td>
                    <td>
                        <input type="text" name="number" value="{{ row.Number }}" class="tab-input"
                            title="Number of exposures." onchange="modify()">
                    </td>
                    <td>
                        <input type="text" name="notes" value="{{ row.Remarks }}" class="tab-input"
                            title="Notes to observation (e.g. IC, photometry)." onchange="modify()">
                    </td>
                    <!-- using td text to allow select and copy whole tab
                     inputs to store data -->
                    <!-- <td contenteditable="true" oninput="updateHiddenInput(this)">
                        <input type="hidden" name="exp" value="{{ row.ExpTime }}" class="tab-input">
                        {{ row.ExpTime }}
                    </td>
                    <td contenteditable="true" oninput="updateHiddenInput(this)">
                        <input type="hidden" name="number" value="{{ row.Number }}" class="tab-input">
                        {{ row.Number }}
                    </td>
                    <td contenteditable="true" oninput="updateHiddenInput(this)">
                        <input type="hidden" name="notes" value="{{ row.Remarks }}" class="tab-input">
                        {{ row.Remarks }}
                    </td> -->
                    <!-- <td>{{ row.ExpTime }}</td>
                    <td>{{ row.Number }}</td>
                    <td>{{ row.Remarks }}</td>                     -->
                    <td>{% if row.Start %}
                        {{row.Start.split()[1][:row.Start.split()[1].rfind(':')] }}
                        {% endif %}
                    </td>
                    <td>{% if row.End %}
                        {{ row.End.split()[1][:row.End.split()[1].rfind(':')] }}
                        {% endif %}
                    </td>
                    <td>{% if not row.Target=='Delay' %}{{ row.Priority }}{% endif %}</td>
                    <td>{% if row.Altitude and not row.Target=='Delay' %}
                        {{ row.Altitude | float() | round(0) | int() }}
                        {% endif %}
                        {% if row.AltitudeStart and not row.Target=='Delay' %}
                        {{ row.AltitudeStart | float() | round(0) | int() }} -
                        {{ row.AltitudeEnd | float() | round(0) | int() }}
                        {% endif %}
                    </td>
                    <td>{% if row.Airmass and not row.Target=='Delay' %}
                        {{ row.Airmass | float() | round(1) }}
                        {% endif %}
                        {% if row.AirmassStart and not row.Target=='Delay' %}
                        {{ row.AirmassStart | float() | round(1) }} - {{ row.AirmassEnd | float() | round(1) }}
                        {% endif %}
                    </td>
                    <td>{% if row.Azimut and not row.Target=='Delay'%}
                        {{ row.Azimut | float() | round(0) | int() }}
                        {% endif %}
                        {% if row.AzimutStart and not row.Target=='Delay' %}
                        {{ row.AzimutStart | float() | round(0) | int() }} -
                        {{ row.AzimutEnd | float() | round(0) | int() }}
                        {% endif %}
                    </td>
                    <td>{% if row.MoonSeparation and not row.Target=='Delay' %}
                        {{ row.MoonSeparation | float() | round(0) | int() }}
                        {% endif %}
                    </td>
                    {% if not row.Target=='Delay' %}
                    <td {% if row.Position=='-' %}style="background-color: red; " {% endif %}>
                        <span style="display: inline-block; width: 30px">{{ row.Position }}</span>
                        {% if row.Position %}
                        <button type="button" class="modify-row" name="plot" title="Plot telescope limits"
                            onclick="window.open('{{ url_for('limits', ha0 = row.ha0, ha1 = row.ha1, dec=row.de, title=row.Target) }}', '_blank')"
                            formtarget=”_blank”>
                            <img src="{{ url_for('static',filename='preview.svg') }}" alt="preview">
                        </button>
                        {% endif %}
                    </td>
                    {% else %} <td></td>
                    {% endif %}
                </tr>
                {% endfor %}
            </table>
            <br>
            <center>
                <button type="submit" name="calc" id="calc" onclick="return recalc()" {% if not code %}disabled
                    style="background-color:gray; color: black; cursor: default;" {% endif %}
                    title="Re-calculate observing times and positions of targets.">Re-calculate</button>
                <button type="submit" name="plot" id="plot" onclick="return recalc()" {% if not code %}disabled
                    style="background-color:gray; color: black; cursor: default;" {% endif %}
                    title="Re-calculate observing times, positions of targets and plot figures.">Re-calculate &
                    plot</button>
                <button type="submit" name="run" id="run" onclick="return rerun()" {% if not code %}disabled
                    style="background-color:gray; color: black; cursor: default;" {% endif %}
                    title="Run scheduler with objects in the schedule. It will create new schedule and any unsaved changes will be loosed!">Re-schedule</button>
            </center>
        </form>

        {% if alt_plot %}
        <div>
            <img width="40%" src='data:image/png;base64,{{ alt_plot }}' alt="Altitude plot"
                onclick="img64('{{ alt_plot }}')">
            <img width="40%" src='data:image/png;base64,{{ sky }}' alt="Sky plot" onclick="img64('{{ sky }}')">
        </div>
        {% endif %}

        {% if modify %}
        <script>
            //load schedule for save&modify
            document.getElementById("load").click();
        </script>
        {% endif %}

        {% if scroll %}
        <script>
            window.scrollTo(0, document.body.scrollHeight);
        </script>
        {% endif %}

        <script>
            //change selectbox to selectize mode to be searchable
            $("select#obj").select2();
        </script>

        <script>
            // sorting groups table

            function sortTable(f, n) {
                // get all rows from table
                let rows = $('#group_table tbody  tr').get();

                rows.sort(function (a, b) {
                    // algorithm for sorting

                    let A = getVal(a);
                    let B = getVal(b);

                    if (A < B) {
                        return -1 * f;
                    }
                    if (A > B) {
                        return 1 * f;
                    }
                    return 0;
                });

                function getVal(elm) {
                    let v = $(elm).children('td').eq(n).text().toUpperCase();
                    if ($.isNumeric(v)) {
                        v = parseFloat(v, 10);
                    }
                    return v;
                }

                $.each(rows, function (index, row) {
                    $('#group_table').children('tbody').append(row);
                });
            }
            let f_sl = 1;

            $(function () {

                $("#group_table th").click(function () {
                    var headers = document.getElementsByClassName("group_th");    // get header
                    var old = -1;
                    for (var i = 0; i < headers.length; i++) {
                        // remove symbol from old sorting col and save its index
                        if (headers[i].innerHTML.indexOf('▼') > 0) {
                            old = i;
                            headers[i].innerHTML = headers[i].innerHTML.slice(0, headers[i].innerHTML.indexOf('▼') - 1);
                            break;
                        }
                        if (headers[i].innerHTML.indexOf('▲') > 0) {
                            old = i;
                            headers[i].innerHTML = headers[i].innerHTML.slice(0, headers[i].innerHTML.indexOf('▲') - 1);
                            break;
                        }
                    }

                    let n = $(this).prevAll().length

                    if (old === n) {
                        f_sl *= -1;   // resort old col
                    }
                    else {
                        f_sl = 1;     // sorting using new col
                    }

                    sortTable(f_sl, n)

                    // add symbol to header
                    if (f_sl === -1)
                        $(this).text($(this).text() + " ▼")
                    else
                        $(this).text($(this).text() + " ▲")

                });

            });
        </script>
        <script>
            // sorting object table

            function sortObjTable(f, n) {
                // get all rows from table
                let rows = $('#obj_table tbody  tr').get();

                rows.sort(function (a, b) {
                    // algorithm for sorting

                    let A = getVal(a);
                    let B = getVal(b);

                    if (A < B) {
                        return -1 * f;
                    }
                    if (A > B) {
                        return 1 * f;
                    }
                    return 0;
                });

                function getVal(elm) {
                    let v = $(elm).children('td').eq(n).text().toUpperCase();
                    if (n === 1) {
                        return v.replace(" ", "").replace("-", "").replace("_", "");   //col with target name
                    }
                    if ($.isNumeric(v)) {
                        v = parseFloat(v, 10);
                    }
                    else if ($.isNumeric(v.slice(0, 3))) {
                        v = parseFloat(v.slice(0, 3), 10);    // RA/DEC -> number from 1st part
                    }
                    else if ($.isNumeric(v.slice(0, 2))) {
                        v = parseFloat(v.slice(0, 2), 10);     // RA/DEC -> number from 1st part
                    }
                    else if (v === 'SERIES') {
                        v = 50;                                 // number of exp.=series -> set some big number
                    }
                    return v;
                }

                $.each(rows, function (index, row) {
                    $('#obj_table').children('tbody').append(row);
                });
            }
            let f_slO = 1;

            $(function () {

                $("#obj_table th").click(function () {
                    var headers = document.getElementsByClassName("obj_th");    // get header
                    var old = -1;
                    for (var i = 0; i < headers.length; i++) {
                        // remove symbol from old sorting col and save its index
                        if (headers[i].innerHTML.indexOf('▼') > 0) {
                            old = i;
                            headers[i].innerHTML = headers[i].innerHTML.slice(0, headers[i].innerHTML.indexOf('▼') - 1);
                            break;
                        }
                        if (headers[i].innerHTML.indexOf('▲') > 0) {
                            old = i;
                            headers[i].innerHTML = headers[i].innerHTML.slice(0, headers[i].innerHTML.indexOf('▲') - 1);
                            break;
                        }
                    }

                    let n = $(this).prevAll().length

                    if (old === n) {
                        f_slO *= -1;   // resort old col
                    }
                    else {
                        f_slO = 1;     // sorting using new col
                    }

                    sortObjTable(f_slO, n)

                    // add symbol to header
                    if (f_slO === -1)
                        $(this).text($(this).text() + " ▼")
                    else
                        $(this).text($(this).text() + " ▲")

                });

            });
        </script>

    </body>

</html>